#!/bin/sh -e
# Environment variables passed in by TC: $HASH and $BRANCH

APP_NAME=lagotto
SHORT_HASH=$(echo "$HASH" | cut -b 1-7)
export SHORT_HASH
# Cleaned for use a docker tag: only a-z0-9-_ allowed
CLEAN_BRANCH=$(printf "%s" "$BRANCH" | tr -c '[:alnum:]-_' '_')
export CLEAN_BRANCH

UID=$(id -u)
export UID
GID=$(id -g)
export GID

mkdir -p artifacts/

echo "##teamcity[importData type='junit' file='./artifacts/rspec.xml']"

docker-compose down -v
docker-compose build
docker-compose run -e RAILS_ENV=test app docker/wait-for.sh -t 30 db:3306 -- rake db:setup
docker-compose run -e RAILS_ENV=test app bundle exec rspec --format RspecJunitFormatter --out artifacts/rspec.xml

docker tag "plos/$APP_NAME:$CLEAN_BRANCH-$SHORT_HASH" "plos/$APP_NAME:$CLEAN_BRANCH"
docker push "plos/$APP_NAME:$CLEAN_BRANCH"
docker push "plos/$APP_NAME:$CLEAN_BRANCH-$SHORT_HASH"
docker-compose down -v