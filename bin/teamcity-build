#!/bin/bash
# Environment variables passed in by TC: $HASH and $BRANCH
set -ex

APP_NAME=lagotto
SHORT_HASH=$(echo "$HASH" | cut -b 1-7)
export SHORT_HASH
# Cleaned for use a docker tag: only a-z0-9-_ allowed
CLEAN_BRANCH=$(printf "%s" "$BRANCH" | tr -c '[:alnum:]-_' '_')
export CLEAN_BRANCH

rm -rf artifacts/

echo "##teamcity[importData type='junit' file='./artifacts/rspec.xml']"

function export_results {
    docker-compose run -T appserver tar czf - artifacts/ | tar xzf -
    docker-compose down -v
}

trap export_results EXIT

docker-compose down -v
docker-compose build
docker-compose run -e RAILS_ENV=test appserver docker/wait-for.sh -t 30 db:3306 -- rake db:setup
docker-compose run -e RAILS_ENV=test appserver bundle exec rspec --format RspecJunitFormatter --out artifacts/rspec.xml

if [ -n "$TEAMCITY_VERSION" ] ; then
    docker tag "plos/$APP_NAME:$CLEAN_BRANCH-$SHORT_HASH" "plos/$APP_NAME:$CLEAN_BRANCH"
    docker push "plos/$APP_NAME:$CLEAN_BRANCH"
    docker push "plos/$APP_NAME:$CLEAN_BRANCH-$SHORT_HASH"
fi